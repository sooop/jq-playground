<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jq Playground</title>
    <script src="https://cdn.jsdelivr.net/npm/jq-web@0.5.1/jq.wasm.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100vh;
            gap: 1px;
            background: #ddd;
        }

        .header {
            background: #fff;
            padding: 16px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 500;
            letter-spacing: -0.3px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .main {
            display: grid;
            grid-template-rows: 1fr 1fr;
            gap: 1px;
            background: #ddd;
            overflow: hidden;
        }

        .top-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: #ddd;
        }

        .panel {
            background: #fff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }

        .panel-title {
            font-size: 13px;
            font-weight: 500;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .panel-actions {
            display: flex;
            gap: 6px;
        }

        .panel-content {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        textarea, .output-content {
            width: 100%;
            height: 100%;
            border: none;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            background: #fff;
            color: #333;
        }

        textarea:focus {
            outline: none;
            background: #fefefe;
        }

        textarea::placeholder {
            color: #aaa;
        }

        .output-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: auto;
        }

        .drag-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            border: 2px dashed #ccc;
            margin: 16px;
        }

        .drag-overlay.active {
            display: flex;
        }

        button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #fff;
            color: #333;
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
        }

        button:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        button:active {
            background: #eee;
        }

        button.primary {
            background: #333;
            color: #fff;
            border-color: #333;
        }

        button.primary:hover {
            background: #444;
        }

        .cheatsheet {
            background: #fafafa;
            border-bottom: 1px solid #e5e5e5;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .cheatsheet.open {
            max-height: 200px;
            overflow-y: auto;
        }

        .cheatsheet-content {
            padding: 12px 16px;
            font-size: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .cheatsheet-item {
            cursor: pointer;
            padding: 6px 8px;
            background: #fff;
            border: 1px solid #e5e5e5;
            transition: all 0.15s;
        }

        .cheatsheet-item:hover {
            border-color: #ccc;
            background: #f9f9f9;
        }

        .cheatsheet-item code {
            color: #666;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .error-banner {
            background: #fff3f3;
            border-left: 3px solid #d33;
            padding: 12px 16px;
            font-size: 12px;
            color: #d33;
            display: none;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .error-banner.show {
            display: block;
        }

        select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: #fff;
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
        }

        .history-dropdown {
            position: relative;
        }

        .history-list {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: #fff;
            border: 1px solid #ddd;
            min-width: 250px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .history-list.show {
            display: block;
        }

        .history-item {
            padding: 8px 12px;
            font-size: 12px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s;
        }

        .history-item:hover {
            background: #f5f5f5;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .saved-query-item {
            padding: 10px 12px;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s;
        }

        .saved-query-item:hover {
            background: #f5f5f5;
        }

        .saved-query-item:last-child {
            border-bottom: none;
        }

        .saved-query-name {
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-query-meta {
            font-size: 11px;
            color: #999;
            margin-bottom: 4px;
        }

        .saved-query-preview {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-saved-query {
            padding: 2px 6px;
            font-size: 11px;
            border: none;
            background: transparent;
            color: #d33;
            cursor: pointer;
        }

        .delete-saved-query:hover {
            background: #fff3f3;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: #fff;
            border: 1px solid #ddd;
            padding: 24px;
            min-width: 400px;
            max-width: 90vw;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .modal-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .modal-field {
            margin-bottom: 16px;
        }

        .modal-label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            font-size: 13px;
            font-family: inherit;
        }

        .modal-input:focus {
            outline: none;
            border-color: #999;
        }

        .modal-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            font-size: 13px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            resize: vertical;
            min-height: 80px;
        }

        .modal-textarea:focus {
            outline: none;
            border-color: #999;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .saved-queries-list {
            min-width: 350px;
            max-width: 500px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th, td {
            padding: 8px 12px;
            text-align: left;
            border: 1px solid #e5e5e5;
        }

        th {
            background: #fafafa;
            font-weight: 500;
            color: #666;
        }

        tr:hover {
            background: #fafafa;
        }

        .loading {
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>jq Playground</h1>
            <div class="header-actions">
                <button onclick="loadSample()">Load Sample</button>
                <button onclick="toggleCheatsheet()">Syntax</button>
                <a href="https://jqlang.github.io/jq/manual/" target="_blank" style="text-decoration: none;">
                    <button>Manual</button>
                </a>
            </div>
        </div>

        <div class="main">
            <div class="top-panel">
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Input</span>
                        <div class="panel-actions">
                            <button onclick="clearInput()">Clear</button>
                            <button onclick="document.getElementById('fileInput').click()">Load File</button>
                            <input type="file" id="fileInput" accept=".json,.txt" style="display: none;" onchange="loadFile(event)">
                        </div>
                    </div>
                    <div class="panel-content">
                        <textarea id="input" placeholder="Paste JSON here or drag & drop a file...">{
  "users": [
    {"name": "Alice", "age": 30, "city": "Seoul"},
    {"name": "Bob", "age": 25, "city": "Busan"}
  ]
}</textarea>
                        <div class="drag-overlay" id="dragOverlay">Drop file here</div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Query</span>
                        <div class="panel-actions history-dropdown">
                            <button onclick="showSaveQueryDialog()">Save</button>
                            <button onclick="toggleSavedQueries()">Saved</button>
                            <button onclick="toggleHistory()">History</button>
                            <button onclick="clearQuery()">Clear</button>
                            <div class="history-list" id="historyList"></div>
                            <div class="history-list saved-queries-list" id="savedQueriesList"></div>
                        </div>
                    </div>
                    <div class="cheatsheet" id="cheatsheet">
                        <div class="cheatsheet-content">
                            <div class="cheatsheet-item" onclick="insertQuery('.')">
                                <code>.</code> - Identity
                            </div>
                            <div class="cheatsheet-item" onclick="insertQuery('.[]')">
                                <code>.[]</code> - Array iterator
                            </div>
                            <div class="cheatsheet-item" onclick="insertQuery('.key')">
                                <code>.key</code> - Object field
                            </div>
                            <div class="cheatsheet-item" onclick="insertQuery('.[0]')">
                                <code>.[0]</code> - Array index
                            </div>
                            <div class="cheatsheet-item" onclick="insertQuery('select(.age > 25)')">
                                <code>select()</code> - Filter
                            </div>
                            <div class="cheatsheet-item" onclick="insertQuery('map(.name)')">
                                <code>map()</code> - Transform
                            </div>
                            <div class="cheatsheet-item" onclick="insertQuery('group_by(.city)')">
                                <code>group_by()</code> - Group
                            </div>
                            <div class="cheatsheet-item" onclick="insertQuery('sort_by(.age)')">
                                <code>sort_by()</code> - Sort
                            </div>
                            <div class="cheatsheet-item" onclick="insertQuery('to_entries')">
                                <code>to_entries</code> - Convert
                            </div>
                            <div class="cheatsheet-item" onclick="insertQuery('keys')">
                                <code>keys</code> - Object keys
                            </div>
                            <div class="cheatsheet-item" onclick="insertQuery('length')">
                                <code>length</code> - Count
                            </div>
                            <div class="cheatsheet-item" onclick="insertQuery('if .age > 25 then \"adult\" else \"young\" end')">
                                <code>if-then-else</code> - Condition
                            </div>
                        </div>
                    </div>
                    <div class="panel-content">
                        <textarea id="query" placeholder="Enter jq query...">.users[] | select(.age > 25)</textarea>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Output</span>
                    <div class="panel-actions">
                        <select id="formatSelect" onchange="executeQuery()">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                        </select>
                        <button onclick="copyOutput()">Copy</button>
                        <button onclick="downloadOutput()">Download</button>
                    </div>
                </div>
                <div class="error-banner" id="errorBanner"></div>
                <div class="panel-content">
                    <div class="output-content" id="output"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="saveQueryModal">
        <div class="modal">
            <div class="modal-title">Save Query</div>
            <div class="modal-field">
                <label class="modal-label">Name</label>
                <input type="text" class="modal-input" id="queryName" placeholder="Enter query name...">
            </div>
            <div class="modal-field">
                <label class="modal-label">Query</label>
                <textarea class="modal-textarea" id="queryToSave" readonly></textarea>
            </div>
            <div class="modal-actions">
                <button onclick="closeSaveQueryDialog()">Cancel</button>
                <button class="primary" onclick="saveQuery()">Save</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jq-web@0.5.1/jq.wasm.js"></script>
    <script>
        let jqInstance = null;
        let jqWorker = null;
        let queryHistory = [];
        let savedQueries = [];
        let lastResultData = null;  // CSV 다운로드용 전체 데이터
        const MAX_HISTORY = 20;

        // Initialize jq and Web Worker
        async function initJq() {
            try {
                document.getElementById('output').innerHTML = '<span class="loading">Loading jq engine...</span>';

                // 메인 스레드에서 jq 로드
                jqInstance = await jq.promised;

                // Web Worker 생성 (메시지 기반 작업용)
                const workerCode = `
                    // 메인 스레드로부터 메시지 수신
                    self.onmessage = async function(event) {
                        const { input, query, format, jqCode } = event.data;

                        try {
                            // 메인 스레드에서 전달받은 jq 함수 사용
                            // 여기서는 간단히 JSON 처리만 수행
                            const parsedInput = JSON.parse(input);

                            // 실제 jq 처리는 메인 스레드로 전달
                            self.postMessage({
                                type: 'process',
                                input: parsedInput,
                                query: query,
                                format: format
                            });
                        } catch (error) {
                            self.postMessage({
                                type: 'error',
                                message: error.message
                            });
                        }
                    };
                `;

                const blob = new Blob([workerCode], { type: 'application/javascript' });
                const workerUrl = URL.createObjectURL(blob);
                jqWorker = new Worker(workerUrl);

                // Worker 메시지 처리
                jqWorker.onmessage = handleWorkerMessage;

                jqWorker.onerror = function(error) {
                    showError('Worker 에러: ' + error.message);
                };

                // 초기화 완료
                loadHistory();
                loadSavedQueries();
                executeQuery();
            } catch (error) {
                showError('Failed to initialize jq engine: ' + error.message);
            }
        }

        // Worker 메시지 처리 함수
        async function handleWorkerMessage(event) {
            const { type, message, input, query, format } = event.data;

            if (type === 'process') {
                // Worker에서 JSON 파싱 완료, 메인 스레드에서 jq 처리
                try {
                    const result = await jqInstance.json(input, query);

                    // 전체 데이터 저장 (CSV 다운로드용)
                    lastResultData = result;

                    // Add to history
                    addToHistory(query);

                    // Format output
                    if (format === 'json') {
                        const output = JSON.stringify(result, null, 2);
                        document.getElementById('output').textContent = output;
                    } else if (format === 'csv') {
                        document.getElementById('output').innerHTML = jsonToCSV(result);
                    }

                    hideError();
                } catch (error) {
                    showError(error.message);
                    document.getElementById('output').textContent = '';
                    lastResultData = null;
                }
            } else if (type === 'error') {
                showError(message);
                document.getElementById('output').textContent = '';
                lastResultData = null;
            }
        }

        // Execute jq query
        let debounceTimer;
        function executeQuery() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (!jqWorker) {
                    showError('jq engine not initialized');
                    return;
                }

                const input = document.getElementById('input').value.trim();
                const query = document.getElementById('query').value.trim();
                const format = document.getElementById('formatSelect').value;

                if (!input) {
                    document.getElementById('output').textContent = '';
                    hideError();
                    return;
                }

                if (!query) {
                    document.getElementById('output').textContent = '';
                    hideError();
                    return;
                }

                // 처리 중 표시
                document.getElementById('output').innerHTML = '<span class="loading">Processing...</span>';

                // Worker에 메시지 전송
                jqWorker.postMessage({
                    input: input,
                    query: query,
                    format: format
                });
            }, 500);
        }

        // Convert JSON to CSV
        function jsonToCSV(data) {
            if (!Array.isArray(data)) {
                data = [data];
            }

            if (data.length === 0) {
                return '<div>No data</div>';
            }

            // Flatten objects with depth limit
            function flatten(obj, prefix = '', depth = 0) {
                const MAX_DEPTH = 10;  // 최대 10단계까지만 펼침
                const flattened = {};

                for (const key in obj) {
                    const value = obj[key];
                    const newKey = prefix ? `${prefix}_${key}` : key;

                    if (value === null || value === undefined) {
                        flattened[newKey] = '';
                    } else if (typeof value === 'object' && !Array.isArray(value)) {
                        if (depth < MAX_DEPTH) {
                            // 깊이 제한 미도달 → 계속 펼침
                            Object.assign(flattened, flatten(value, newKey, depth + 1));
                        } else {
                            // 깊이 제한 도달 → JSON으로 직렬화
                            flattened[newKey] = JSON.stringify(value);
                        }
                    } else if (Array.isArray(value)) {
                        flattened[newKey] = JSON.stringify(value);
                    } else {
                        flattened[newKey] = value;
                    }
                }
                return flattened;
            }

            // Expand array items into separate rows
            const MAX_TABLE_ROWS = 1000;  // 테이블 표시 최대 행 수
            const rows = [];
            for (const item of data) {
                const flattened = flatten(item);
                rows.push(flattened);
            }

            if (rows.length === 0) {
                return '<div>No data</div>';
            }

            // 행 수 제한 경고
            let warningMsg = '';
            let displayRows = rows;
            if (rows.length > MAX_TABLE_ROWS) {
                warningMsg = `<div style="background: #fff3f3; border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; font-size: 12px; color: #d33; border-radius: 4px;">
                    ⚠️ 데이터가 너무 많습니다. 테이블에 첫 ${MAX_TABLE_ROWS}행만 표시됩니다. (총 ${rows.length}행)
                    <br/>전체 데이터는 <strong>Download</strong> 버튼으로 CSV 파일로 다운로드하세요.
                </div>`;
                displayRows = rows.slice(0, MAX_TABLE_ROWS);
            }

            // Get all unique keys
            const keys = [...new Set(displayRows.flatMap(row => Object.keys(row)))].sort();

            // Build HTML table
            let html = warningMsg + '<table><thead><tr>';
            keys.forEach(key => {
                html += `<th>${escapeHtml(key)}</th>`;
            });
            html += '</tr></thead><tbody>';

            displayRows.forEach(row => {
                html += '<tr>';
                keys.forEach(key => {
                    const value = row[key] !== undefined ? row[key] : '';
                    html += `<td>${escapeHtml(String(value))}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Error handling
        let errorTimeout;
        function showError(message, autoHideDuration = null) {
            const banner = document.getElementById('errorBanner');
            banner.textContent = message;
            banner.classList.add('show');

            // 기존 타이머 클리어
            if (errorTimeout) clearTimeout(errorTimeout);

            // 지정된 시간 후 자동 종료 (기본: 5초)
            if (autoHideDuration !== false) {
                const duration = autoHideDuration || 5000;  // 기본 5초
                errorTimeout = setTimeout(() => {
                    hideError();
                }, duration);
            }
        }

        function hideError() {
            if (errorTimeout) clearTimeout(errorTimeout);
            document.getElementById('errorBanner').classList.remove('show');
        }

        // File handling
        const MAX_FILE_SIZE = 50 * 1024 * 1024;  // 50MB

        function validateFileSize(file) {
            if (file.size > MAX_FILE_SIZE) {
                showError(`파일이 너무 큽니다. 최대 ${(MAX_FILE_SIZE / 1024 / 1024).toFixed(1)}MB까지만 허용됩니다. (현재: ${(file.size / 1024 / 1024).toFixed(1)}MB)`);
                return false;
            }
            return true;
        }

        function loadFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!validateFileSize(file)) {
                event.target.value = '';  // 파일 입력 초기화
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('input').value = e.target.result;
                executeQuery();
            };
            reader.readAsText(file);
        }

        // Drag and drop
        const inputPanel = document.querySelector('.panel-content');
        const dragOverlay = document.getElementById('dragOverlay');

        inputPanel.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragOverlay.classList.add('active');
        });

        inputPanel.addEventListener('dragleave', (e) => {
            if (e.target === inputPanel) {
                dragOverlay.classList.remove('active');
            }
        });

        inputPanel.addEventListener('drop', (e) => {
            e.preventDefault();
            dragOverlay.classList.remove('active');

            const file = e.dataTransfer.files[0];
            if (!file) return;

            if (!validateFileSize(file)) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                document.getElementById('input').value = event.target.result;
                executeQuery();
            };
            reader.readAsText(file);
        });

        // Query history
        function addToHistory(query) {
            if (!query || query === queryHistory[0]) return;
            
            queryHistory = queryHistory.filter(q => q !== query);
            queryHistory.unshift(query);
            
            if (queryHistory.length > MAX_HISTORY) {
                queryHistory = queryHistory.slice(0, MAX_HISTORY);
            }
            
            saveHistory();
            renderHistory();
        }

        function saveHistory() {
            localStorage.setItem('jq-history', JSON.stringify(queryHistory));
        }

        function loadHistory() {
            try {
                const saved = localStorage.getItem('jq-history');
                if (saved) {
                    queryHistory = JSON.parse(saved);
                    renderHistory();
                }
            } catch (e) {
                console.error('Failed to load history:', e);
            }
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            if (queryHistory.length === 0) {
                list.innerHTML = '<div class="history-item" style="cursor: default; color: #999;">No history</div>';
                return;
            }

            list.innerHTML = queryHistory.map(q => 
                `<div class="history-item" onclick="loadFromHistory('${escapeHtml(q).replace(/'/g, "\\'")}')">${escapeHtml(q)}</div>`
            ).join('');
        }

        function loadFromHistory(query) {
            document.getElementById('query').value = query;
            toggleHistory();
            executeQuery();
        }

        function toggleHistory() {
            document.getElementById('historyList').classList.toggle('show');
        }

        // Close history when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.querySelector('.history-dropdown');
            if (!dropdown.contains(e.target)) {
                document.getElementById('historyList').classList.remove('show');
                document.getElementById('savedQueriesList').classList.remove('show');
            }
        });

        // Saved queries management
        function showSaveQueryDialog() {
            const query = document.getElementById('query').value.trim();
            if (!query) {
                showError('Please enter a query to save');
                return;
            }

            document.getElementById('queryToSave').value = query;
            document.getElementById('queryName').value = '';
            document.getElementById('saveQueryModal').classList.add('show');
            document.getElementById('queryName').focus();
        }

        function closeSaveQueryDialog() {
            document.getElementById('saveQueryModal').classList.remove('show');
        }

        function saveQuery() {
            const name = document.getElementById('queryName').value.trim();
            const query = document.getElementById('queryToSave').value.trim();

            if (!name) {
                alert('Please enter a name for the query');
                return;
            }

            const savedQuery = {
                id: Date.now(),
                name: name,
                query: query,
                timestamp: new Date().toISOString()
            };

            savedQueries.unshift(savedQuery);
            saveSavedQueries();
            renderSavedQueries();
            closeSaveQueryDialog();
        }

        function saveSavedQueries() {
            localStorage.setItem('jq-saved-queries', JSON.stringify(savedQueries));
        }

        function loadSavedQueries() {
            try {
                const saved = localStorage.getItem('jq-saved-queries');
                if (saved) {
                    savedQueries = JSON.parse(saved);
                    renderSavedQueries();
                }
            } catch (e) {
                console.error('Failed to load saved queries:', e);
            }
        }

        function renderSavedQueries() {
            const list = document.getElementById('savedQueriesList');
            if (savedQueries.length === 0) {
                list.innerHTML = '<div class="saved-query-item" style="cursor: default; color: #999; padding: 12px;">No saved queries</div>';
                return;
            }

            list.innerHTML = savedQueries.map(sq => {
                const date = new Date(sq.timestamp);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                const preview = sq.query.length > 50 ? sq.query.substring(0, 50) + '...' : sq.query;
                
                return `
                    <div class="saved-query-item">
                        <div class="saved-query-name">
                            <span onclick="loadSavedQuery(${sq.id})">${escapeHtml(sq.name)}</span>
                            <button class="delete-saved-query" onclick="event.stopPropagation(); deleteSavedQuery(${sq.id})">Delete</button>
                        </div>
                        <div class="saved-query-meta">${dateStr}</div>
                        <div class="saved-query-preview" onclick="loadSavedQuery(${sq.id})">${escapeHtml(preview)}</div>
                    </div>
                `;
            }).join('');
        }

        function loadSavedQuery(id) {
            const query = savedQueries.find(q => q.id === id);
            if (query) {
                document.getElementById('query').value = query.query;
                toggleSavedQueries();
                executeQuery();
            }
        }

        function deleteSavedQuery(id) {
            if (!confirm('Delete this saved query?')) return;
            
            savedQueries = savedQueries.filter(q => q.id !== id);
            saveSavedQueries();
            renderSavedQueries();
        }

        function toggleSavedQueries() {
            const list = document.getElementById('savedQueriesList');
            const historyList = document.getElementById('historyList');
            
            historyList.classList.remove('show');
            list.classList.toggle('show');
        }

        // Utility functions
        function clearInput() {
            document.getElementById('input').value = '';
            executeQuery();
        }

        function clearQuery() {
            document.getElementById('query').value = '';
            executeQuery();
        }

        function loadSample() {
            document.getElementById('input').value = `{
  "users": [
    {"name": "Alice", "age": 30, "city": "Seoul", "hobbies": ["reading", "coding"]},
    {"name": "Bob", "age": 25, "city": "Busan", "hobbies": ["gaming"]},
    {"name": "Charlie", "age": 35, "city": "Seoul", "hobbies": ["music", "sports", "travel"]}
  ],
  "metadata": {
    "timestamp": "2025-11-14",
    "version": "1.0"
  }
}`;
            document.getElementById('query').value = '.users[] | select(.city == "Seoul")';
            executeQuery();
        }

        function copyOutput() {
            const output = document.getElementById('output');
            const text = output.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 1500);
            });
        }

        function downloadOutput() {
            const format = document.getElementById('formatSelect').value;
            let text;

            if (format === 'json') {
                const output = document.getElementById('output');
                text = output.textContent;
            } else if (format === 'csv') {
                // CSV는 전체 데이터를 사용 (화면 제한 무시)
                if (lastResultData) {
                    text = convertTableToCSVData(lastResultData);
                } else {
                    showError('데이터가 없습니다.');
                    return;
                }
            }

            const blob = new Blob([text], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `output.${format === 'json' ? 'json' : 'csv'}`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 화면 테이블에서 CSV 추출 (제한된 행)
        function convertTableToCSV() {
            const table = document.querySelector('#output table');
            if (!table) return document.getElementById('output').textContent;

            const rows = [];
            const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent);
            rows.push(headers.join(','));

            table.querySelectorAll('tbody tr').forEach(tr => {
                const cells = Array.from(tr.querySelectorAll('td')).map(td => {
                    let text = td.textContent;
                    if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                        text = '"' + text.replace(/"/g, '""') + '"';
                    }
                    return text;
                });
                rows.push(cells.join(','));
            });

            return rows.join('\n');
        }

        // 전체 데이터를 CSV로 변환 (다운로드용)
        function convertTableToCSVData(data) {
            if (!Array.isArray(data)) {
                data = [data];
            }

            if (data.length === 0) {
                return '';
            }

            // 동일한 flatten 로직 적용
            function flatten(obj, prefix = '', depth = 0) {
                const MAX_DEPTH = 10;
                const flattened = {};

                for (const key in obj) {
                    const value = obj[key];
                    const newKey = prefix ? `${prefix}_${key}` : key;

                    if (value === null || value === undefined) {
                        flattened[newKey] = '';
                    } else if (typeof value === 'object' && !Array.isArray(value)) {
                        if (depth < MAX_DEPTH) {
                            Object.assign(flattened, flatten(value, newKey, depth + 1));
                        } else {
                            flattened[newKey] = JSON.stringify(value);
                        }
                    } else if (Array.isArray(value)) {
                        flattened[newKey] = JSON.stringify(value);
                    } else {
                        flattened[newKey] = value;
                    }
                }
                return flattened;
            }

            // 전체 데이터 flatten
            const rows = [];
            for (const item of data) {
                const flattened = flatten(item);
                rows.push(flattened);
            }

            // 모든 키 수집
            const keys = [...new Set(rows.flatMap(row => Object.keys(row)))].sort();

            // CSV 헤더
            let csv = keys.map(k => `"${k.replace(/"/g, '""')}"`).join(',') + '\n';

            // CSV 행들
            rows.forEach(row => {
                const cells = keys.map(key => {
                    let value = row[key] !== undefined ? String(row[key]) : '';
                    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csv += cells.join(',') + '\n';
            });

            return csv;
        }

        function toggleCheatsheet() {
            document.getElementById('cheatsheet').classList.toggle('open');
        }

        function insertQuery(query) {
            const textarea = document.getElementById('query');
            const current = textarea.value;
            
            if (current.trim() === '') {
                textarea.value = query;
            } else {
                textarea.value = current + ' | ' + query;
            }
            
            textarea.focus();
            executeQuery();
        }

        // Tab key handling for textareas
        function handleTabKey(e) {
            if (e.key !== 'Tab') return;

            e.preventDefault();
            const TAB_SIZE = 4;
            const INDENT = ' '.repeat(TAB_SIZE);
            const textarea = e.target;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const value = textarea.value;

            if (start === end) {
                // No selection
                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                const beforeCursor = value.substring(lineStart, start);

                // Check if only whitespace before cursor (for Shift+Tab)
                if (e.shiftKey && /^[ \t]*$/.test(beforeCursor)) {
                    // Unindent: remove 1 tab or up to 4 leading spaces from current line
                    const match = beforeCursor.match(/^(?:\t|( {1,4}))/);
                    if (match) {
                        const removed = match[0].length;
                        textarea.value = value.substring(0, lineStart) + value.substring(lineStart + removed);
                        textarea.selectionStart = textarea.selectionEnd = start - removed;
                    }
                } else if (!e.shiftKey) {
                    // Indent: insert 4 spaces
                    textarea.value = value.substring(0, start) + INDENT + value.substring(end);
                    textarea.selectionStart = textarea.selectionEnd = start + TAB_SIZE;
                }
            } else {
                // Selection exists - indent/unindent lines
                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                const lineEnd = value.indexOf('\n', end);
                const selectedLines = value.substring(lineStart, lineEnd === -1 ? value.length : lineEnd);

                let newLines;
                let totalOffset = 0;

                if (e.shiftKey) {
                    // Shift+Tab: unindent (remove up to 4 leading spaces)
                    const lines = selectedLines.split('\n');
                    newLines = lines.map((line, index) => {
                        const match = line.match(/^( {1,4})/);
                        if (match) {
                            const removed = match[1].length;
                            totalOffset -= removed;
                            return line.substring(removed);
                        }
                        return line;
                    }).join('\n');
                } else {
                    // Tab: indent (add 4 spaces)
                    const lines = selectedLines.split('\n');
                    newLines = lines.map(line => INDENT + line).join('\n');
                    totalOffset = newLines.length - selectedLines.length;
                }

                textarea.value = value.substring(0, lineStart) + newLines + value.substring(lineEnd === -1 ? value.length : lineEnd);

                // Adjust selection
                if (e.shiftKey) {
                    const firstLineRemoved = selectedLines.split('\n')[0].match(/^( {1,4})/) ?
                                            selectedLines.split('\n')[0].match(/^( {1,4})/)[1].length : 0;
                    textarea.selectionStart = start - (lineStart === start ? firstLineRemoved : 0);
                    textarea.selectionEnd = end + totalOffset + (lineStart === start ? firstLineRemoved : 0);
                } else {
                    textarea.selectionStart = start + (lineStart === start ? TAB_SIZE : 0);
                    textarea.selectionEnd = end + totalOffset;
                }
            }
        }

        // Event listeners
        document.getElementById('input').addEventListener('input', executeQuery);
        document.getElementById('query').addEventListener('input', executeQuery);
        document.getElementById('input').addEventListener('keydown', handleTabKey);
        document.getElementById('query').addEventListener('keydown', handleTabKey);

        // Modal keyboard shortcuts
        document.getElementById('queryName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveQuery();
            }
        });

        document.getElementById('saveQueryModal').addEventListener('click', (e) => {
            if (e.target.id === 'saveQueryModal') {
                closeSaveQueryDialog();
            }
        });

        // Initialize
        initJq();
    </script>
</body>
</html>